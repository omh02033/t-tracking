<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="/stylesheets/fontawesome-free-5.13.0-web/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/manu.css">
    <link rel="stylesheet" href="/stylesheets/top.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <title>택배 조회 기록</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            height: fit-content;
            min-height: 850px;
        }
        .mlogin table a {
            color: #8b4a00;
            font-size: 12px;
            font-weight: normal;
            text-decoration: none;
        }
        .mlogin {
            position: absolute;
            right: 50px;
        }
        .mlogin table {
            text-align: left;
            border-collapse: unset !important;
        }
        .mlogin table td, .mlogin table th {
            padding: 2px !important;
        }
        .main {
            width: 100%;
            height: fit-content;
        }
        .main1 {
            width: 100%;
            position: absolute;
            top: 90px;
            right: 0;
        }
        #show table {
            margin-bottom: 50px;
            table-layout: fixed;
        }
        .main1 h2 { font-size: 35px; }
        .main1 h3 { font-size: 28px; }
        .main1 h4 { font-size: 20px; }
        #show table tr:first-child td:first-child { width: 33.33333%; }
        #show table tr:first-child td:last-child { width: 66.66667%; }
        .profile {
            width: fit-content;
            height: 100px;
            margin: auto;
            display: flex;
            align-items: center;
        }
        .filebox {
            width: fit-content;
            margin: auto;
        }
        .filebox input[type="file"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip:rect(0,0,0,0);
            border: 0;
        }
        .filebox label, .formdown {
            display: inline-block;
            padding: .5em .75em;
            color: white !important;
            font-weight: bold;
            font-size: inherit;
            line-height: normal;
            vertical-align: middle;
            background: linear-gradient(#ff951c, #ea7d00);
            cursor: pointer;
            border: 1px solid #ebebeb;
            border-bottom-color: #e2e2e2;
            border-radius: .25em;
        }
        .filebox .upload-name {
            display: inline-block;
            padding: .5em .75em;
            font-size: inherit;
            font-family: inherit;
            line-height: normal;
            vertical-align: middle;
            background-color: #f5f5f5;
            border: 1px solid #ebebeb;
            border-bottom-color: #e2e2e2;
            border-radius: .25em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            height: 17px;
            width: fit-content;
            margin: 0;
        }
        #userprofile {
            height: 62%;
            width: 65px;
            border-radius: 50px;
            padding: 5px;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            cursor: pointer;
        }
        #show table { margin: auto; }
        @media only screen and (max-width: 600px) {
            .changepass, .changepassh {
                margin: 100%;
            }
            .exp span {
                font-size: 35px;
            }
            #menubar {
                display: none;
            }
            #show { padding: 0 40px; }
            #show table { width: 100%; }
        }
        @media only screen and (min-width: 1200.01px) {
            .changepass, .changepassh {
                width: 60%;
                margin: auto;
            }
            .mmlogin {
                display: none;
            }
            #mmenubar {
                display: none;
            }
            #show { padding: 10px 80px; }
            #show table { width: 70%; }
        }
        @media only screen and (min-width: 993px) and (max-width: 1200px) {
            .changepass, .changepassh {
                width: 60%;
                margin: auto;
            }
            .mmlogin {
                display: none;
            }
            #mmenubar {
                display: none;
            }
            .mlogin {
                display: none;
            }
            #show { padding: 10px 80px; }
            #show table { width: 70%; }
        }
        @media only screen and (min-width: 601px) and (max-width: 992px) {
            .changepass, .changepassh {
                width: 100%;
            }
            .mmlogin {
                display: none;
            }
            #mmenubar {
                display: none;
            }
            .mlogin {
                display: none;
            }
            #show { padding: 10px 80px; }
            #show table { width: 70%; }
        }
    </style>
    <script src="/javascripts/IProfile.js"></script>
</head>
<body>
    <div class="top row">
        <div class="logo hide-on-med-and-down" onclick="location.replace('/');">
            <i class="fa fa-truck" style="cursor:pointer;"></i>
        </div>
        <div class="exp">
            <span>계정 설정</span>
        </div>
        <div class="mlogin hide-on-med-and-down">
            <table id="logined">
                <tbody>
                    <tr><td><%= decoded.uname %> : <%= decoded.uid %> | </td><td style="margin-left: 10px !important;"><a href="/account/logout">로그아웃</a></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="main">
        <div class="menu">
            <div class="welcometap">
                <div class="wel1">
                    <% if(decoded) { %>
                        <label class="lweltext"><%=decoded.uname%>님 어서오세요!</label>
                        <img src="/images/userProfile/<%=decoded.unum%>" onerror="this.src='/images/userProfile/none.png';" class="profileImg">
                        <div class="lbtn">
                            <button class="lo" onclick="location.replace('/loginuser/searchrecord/');">조회했던 택배 보기</button>
                        </div>
                    <% } else { %>
                        <div class="profileImg" style="display: none;"></div>
                        <label class="weltext">처음 오셨나요?</label>
                        <i class="fa fa-boxes"></i>
                        <div class="lbtn">
                            <button class="lo" onclick="location.replace('/account/login/')">로그인</button>
                            <button class="lo" onclick="location.replace('/account/signup/');">회원가입</button>
                        </div>
                    <% } %>
                </div>
            </div>
            <div class="menutap menutap1" onclick="location.replace('/');">택배 조회 (메인 화면)</div>
            <% if(seller) { %>
                <div class="menutap menutap15" onclick="location.replace('/loginuser/delienr');">운송장 등록</div>
            <% } %>
            <div class="menutap menutap2" onclick="location.replace('/loginuser/tmanage');">택배 관리</div>
            <div class="menutap menutap3" onclick="location.replace('/loginuser/searchrecord');">택배 조회 기록</div>
            <div class="menutap menutap5 sel" onclick="location.replace('/loginuser/setting');">설정</div>
            <div class="menutap menutap55" onclick="location.replace('/loginuser/chat');">판매자와 채팅</div>
            <div class="menutap menutap6" onclick="location.replace('/about/');">더보기</div>
        </div>
        <div class="mmenu" id="semenu">
            <div class="mwelcometap">
                <div class="mwel1">
                    <% if(decoded) { %>
                        <label class="lweltext"><%=decoded.uname%>님 어서오세요!</label>
                        <img src="/images/userProfile/<%=decoded.unum%>" onerror="this.src='/images/userProfile/none.png';" class="mprofileImg">
                        <div class="lbtn">
                            <button class="lo" onclick="location.replace('/loginuser/searchrecord/');">조회했던 택배 보기</button>
                        </div>
                    <% } else { %>
                        <div class="mprofileImg" style="display: none;"></div>
                        <label class="weltext">처음 오셨나요?</label>
                        <i class="fa fa-boxes"></i>
                        <div class="lbtn">
                            <button class="lo" onclick="location.replace('/account/login/')">로그인</button>
                            <button class="lo" onclick="location.replace('/account/signup/');">회원가입</button>
                        </div>
                    <% } %>
                </div>
            </div>
            <div class="mmenutap menutap1" onclick="location.replace('/');">택배 조회 (메인 화면)</div>
            <% if(seller) { %>
                <div class="mmenutap menutap15" onclick="location.replace('/loginuser/delienr');">운송장 등록</div>
            <% } %>
            <div class="mmenutap menutap2" onclick="location.replace('/loginuser/tmanage');">택배 관리</div>
            <div class="mmenutap menutap3" onclick="location.replace('/loginuser/searchrecord');">택배 조회 기록</div>
            <div class="mmenutap menutap5 sel" onclick="location.replace('/loginuser/setting');">설정</div>
            <div class="mmenutap menutap55" onclick="location.replace('/loginuser/chat');">판매자와 채팅</div>
            <div class="mmenutap menutap6" onclick="location.replace('/about/');">더보기</div>
        </div>
        <div class="main1">
            <i class="material-icons" id="menubar" style="font-size: 40px; cursor: pointer;">menu</i>
            <i class="material-icons" id="mmenubar" style="font-size: 40px; cursor: pointer; z-index: 600;">menu</i>

            <% if(decoded) { %>
                <span class="mmlogin" style="position: absolute; top: 20px; right: 10px;"><%=decoded.uname%> : <%=decoded.uid%></span><br>
                <a class="mmlogin" href="/account/logout" style="color: gray; position:absolute; right: 10px; top: 40px;">로그아웃</a>
            <% } else {%>
                <a class="mmlogin" href="/account/login" style="color: gray; position:absolute; right: 10px; top: 30px;">로그인 하러 가기</a>
            <% } %>
            
            <div class="profile">
                <img src="/images/userProfile/<%=decoded.unum%>" onerror="this.src='/images/userProfile/none.png';" id="userprofile">
                <div class="filebox">
                    <form action="/profileUpload/" method="POST" enctype="multipart/form-data" onsubmit="gprofileSub(event, this);">
                        <input class="upload-name" value="이미지 파일선택" disabled="disabled">
                        <label for="ex_filename">선택</label>
                        <input type="file" name="proImage" id="ex_filename" class="upload-hidden" accept="image/png, image/jpg, image/jpeg" onchange="excelExport(event); filecheck(this);">
                        <input type="submit" id="imgsub" style="display: none;">
                    </form>
                </div>
            </div>

            <div id="show">
                <table class="striped">
                    <tbody>
                        <tr>
                            <td>이름</td>
                            <td><%= decoded.uname %></td>
                        </tr>
                        <tr>
                            <td>아이디</td>
                            <td><%= decoded.uid %></td>
                        </tr>
                        <tr>
                            <td>비밀번호</td>
                            <td class="pass"></td>
                        </tr>
                        <tr>
                            <td>전화번호</td>
                            <td class="phone"></td>
                        </tr>
                        <tr>
                            <td>이메일</td>
                            <td class="email"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="changepass" style="display: none; margin: 0 !important;">
                <h3>비밀번호 변경</h3>
                <form action="/account/numcheck/" method="POST" onsubmit="checkpass(event, this);">
                    <input type="password" name="passcheck" id="passcheck" placeholder="현재 비밀번호">
                    <input type="submit" value="확인" id="passchsubmit">
                </form>
            </div>
            <div class="changepassh" style="display: none; margin: 0 !important;">
                <h3>비밀번호 변경</h3>
                <form action="/account/newpass/" method="POST" onsubmit="changenewpass(event, this);">
                    <input type="password" name="newpass" id="newpass" placeholder="새로운 비밀번호"><br>
                    <input type="password" name="passcon" id="passcon" placeholder="비밀번호 확인"><br>
                    <input type="submit" value="확인">
                </form>
            </div>
        </div>
    </div>
    <div id="proselectd">
        <div id="proselect">
            <div id="toppro">
                <% if(decoded) { %>
                    <span style="position: absolute; top: 10px; right: 15px; color:gray;;"><%=decoded.uid%></span>
                    <img src="/images/userProfile/<%=decoded.unum%>" onerror="IProfile();" id="deimg">
                <% } else { %>
                    <i class="far fa-user" style="font-size: 35px;"></i>
                    <div id="deimg" style="display: none !important;"></div>
                <% } %>
                <h4 id="delh4">프로필</h4>
            </div>
            <div id="psoption">
                <div id="originalPro"><span>기본 프로필</span></div>
                <div id="profilechange">
                    <label for="chpro" id="al">프로필 변경</label>
                    <form action="/profileUpload/" method="POST" enctype="multipart/form-data" onsubmit="gprofileSub(event, this);">
                        <input type="file" name="proImage" id="chpro" style="display: none !important;" accept="image/png, image/jpg, image/jpeg" onchange="prochfilecheck(this);">
                        <input type="submit" style="display: none !important;" id="psub">
                    </form>
                </div>
            </div>
            <div id="closeselect"><span>닫기</span></div>
        </div>
    </div>
    <script src="/javascripts/menu.js"></script>
    <script>
        let changepass = document.querySelector(".changepass");
        let changepassh = document.querySelector(".changepassh");

        let newpass = document.getElementById("newpass");
        let passcon = document.getElementById("passcon");

        let proselectd = document.getElementById("proselectd");
        let proselect = document.getElementById("proselect");
        let userprofile = document.getElementById("userprofile");
        let ex_filename = document.getElementById("ex_filename");

        let nowid = "";
        let nowpass = "";
        let nowemail = "";

        let pathpoint = location.href.lastIndexOf('#');
        let path = location.href.substring(pathpoint+1, location.href.length);
        let type = path.toLowerCase();

        function shpr() {
            if(!setoggle) {
                setoggle = true;
                proselectd.style.display = "flex";
                proselect.classList.remove("psc");
                proselect.classList.remove("pso");
                proselect.classList.add("pso");
            }
        }

        userprofile.onclick = () => {
            shpr();
        }

        function cpro(e, form) {
            e.preventDefault();

            let formData = new FormData(form);
            let foo;
            foo = formData;

            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/profileUpload/');
            xhr.onreadystatechange = function () {
                if(xhr.readyState === 4 && xhr.status === 200) {
                    let data = JSON.parse(xhr.responseText);
                    if(data.result == 'success') { location.replace(location.href); }
                }
            }
            xhr.send(foo);
        }

        function filecheck(file) {
            let pathpoint = file.value.lastIndexOf('.');
            let filepoint = file.value.substring(pathpoint+1, file.length);
            let filetype = filepoint.toLowerCase();
            if(filetype == 'png' || filetype == 'jpg' || filetype == 'jpeg') {
                let imgsub = document.getElementById("imgsub");
                imgsub.click();
            } else {
                alert("이미지 파일만 선택 하실수 있습니다.");
                let parentObj = file.parentNode;
                parentObj.replaceChild(file.cloneNode(true),file);
            }
        }

        window.onload = () => {
            let Info = { apploval: true };

            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/account/set/');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if(xhr.readyState === 4 && xhr.status === 200) {
                    let data = JSON.parse(xhr.responseText);
                    if(data.msg) { console.log(data.msg); }

                    nowid = data.userid;
                    nowpass = data.userpass;
                    nowemail = data.useremail;
                    
                    let pass = document.querySelectorAll(".pass");
                    let phone = document.querySelectorAll(".phone");
                    let email = document.querySelectorAll(".email");

                    let starpass = "";

                    for(let i=0; i<data.userpass.length; i++) { starpass += "*"; }
                    let ing = document.getElementById("ing");

                    let  passa = document.createElement("a");
                    passa.innerHTML = "변경";
                    passa.style.marginLeft = "20px";
                    passa.style.cursor = "pointer";
                    passa.onclick = () => { changepass.style.display = "block"; }

                    for(let i=0; i<pass.length; i++) {
                        pass[i].innerHTML = starpass;
                        pass[i].append(passa);
                    }
                    for(let i=0; i<phone.length; i++) { phone[i].innerHTML = data.userphone; }
                    for(let i=0; i<email.length; i++) { email[i].innerHTML = data.useremail; }
                }
            }
            xhr.send(JSON.stringify(Info));
        }

        function checkpass(e, form) {
            e.preventDefault();
            let passcheck = document.getElementById("passcheck");
            let passchsubmit = document.getElementById("passchsubmit");

            if(passcheck.value == nowpass) {
                let userInfo = {
                    result: 'true',
                    uid: nowid,
                    email: nowemail
                }
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/account/numcheck/');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function () {
                    if(xhr.readyState === 4 && xhr.status === 200) {
                        let data = JSON.parse(xhr.responseText);
                        if(data.msg = 'success') {
                            changepass.style.display = "none";
                            changepassh.style.display = "block";
                        }
                    }
                }
                xhr.send(JSON.stringify(userInfo));
            } else {
                passcheck.style.borderBottomColor = "red";
                alert("비밀번호가 일치하지 않습니다.");
            }
        }

        function changenewpass(e, form) {
            e.preventDefault();

            if(newpass.value == passcon.value) {
                let userInfo = {
                    result: 'true',
                    uid: nowid,
                    email: nowemail,
                    newpass: newpass.value
                }
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/account/newpass/');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function () {
                    if(xhr.readyState === 4 && xhr.status === 200) {
                        let data = JSON.parse(xhr.responseText);
                        if(data.result == 'success') {
                            alert("비밀번호가 변경되었습니다.");
                            location.replace(location.href);
                        }
                    }
                }
                xhr.send(JSON.stringify(userInfo));
            } else {
                alert("비밀번호를 확인해 주세요.");
                return;
            }
        }
    </script>
    <script>
        $(document).ready(function(){
            var fileTarget = $('.filebox .upload-hidden');
            fileTarget.on('change', function() {
                if(window.FileReader){
                    var filename = $(this)[0].files[0].name;
                } else {
                    var filename = $(this).val().split('/').pop().split('\\').pop();
                }
                $(this).siblings('.upload-name').val(filename);
            });
        });



        function excelExport(event){
            excelExportCommon(event, handleExcelDataAll);
        }
        function excelExportCommon(event, callback){
            var input = event.target;
            var reader = new FileReader();
            reader.onload = function(){
                var fileData = reader.result;
                var wb = XLSX.read(fileData, {type : 'binary'});
                var sheetNameList = wb.SheetNames; // 시트 이름 목록 가져오기 
                var firstSheetName = sheetNameList[0]; // 첫번째 시트명
                var firstSheet = wb.Sheets[firstSheetName]; // 첫번째 시트 
                callback(firstSheet);      
            };
            reader.readAsBinaryString(input.files[0]);
        }
        function handleExcelDataAll(sheet){
            handleExcelDataHeader(sheet); // header 정보 
            handleExcelDataJson(sheet); // json 형태
            handleExcelDataCsv(sheet); // csv 형태
            handleExcelDataHtml(sheet); // html 형태
        }
        function handleExcelDataHeader(sheet){
            var headers = get_header_row(sheet);
            $("#displayHeaders").html(JSON.stringify(headers));
        }
        function handleExcelDataJson(sheet){
            $("#displayExcelJson").html(JSON.stringify(XLSX.utils.sheet_to_json (sheet)));
        }
        function handleExcelDataCsv(sheet){
            $("#displayExcelCsv").html(XLSX.utils.sheet_to_csv (sheet));
        }
        function handleExcelDataHtml(sheet){
            $("#displayExcelHtml").html(XLSX.utils.sheet_to_html (sheet));
        }
        // 출처 : https://github.com/SheetJS/js-xlsx/issues/214
        function get_header_row(sheet) {
            var headers = [];
            var range = XLSX.utils.decode_range(sheet['!ref']);
            var C, R = range.s.r; /* start in the first row */
            /* walk every column in the range */
            for(C = range.s.c; C <= range.e.c; ++C) {
                var cell = sheet[XLSX.utils.encode_cell({c:C, r:R})] /* find the cell in the first row */

                var hdr = "UNKNOWN " + C; // <-- replace with your desired default 
                if(cell && cell.t) hdr = XLSX.utils.format_cell(cell);

                headers.push(hdr);
            }
            return headers;
        }
    </script>
</body>
</html>